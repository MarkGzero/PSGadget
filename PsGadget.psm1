# Load external dependencies
Add-Type -Path "$PSScriptRoot\lib\ftdisharp\FtdiSharp.dll"
Add-Type -Path "$PSScriptRoot\lib\ftd2xx\FTD2XX_NET.dll"

# Add the glyphs for the SSD1306 display
# Initialize the glyphs hashtable as ordinal
$global:glyphs = New-Object System.Collections.Hashtable ([System.StringComparer]::Ordinal)

# 
if (-not ($glyphs -is [System.Collections.Hashtable])) {
    Write-Error "Glyphs variable is not a hashtable."
    return
} else {
    Write-Host "Glyphs variable initialized successfully."
}

Write-Host "Adding glyphs to the hashtable..."
$glyphs.Add('0', @( 0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E ))
$glyphs.Add('1', @( 0x00, 0x00, 0x42, 0x7F, 0x40, 0x00 ))
$glyphs.Add('2', @( 0x00, 0x42, 0x61, 0x51, 0x49, 0x46 ))
$glyphs.Add('3', @( 0x00, 0x21, 0x41, 0x45, 0x4B, 0x31 ))
$glyphs.Add('4', @( 0x00, 0x18, 0x14, 0x12, 0x7F, 0x10 ))
$glyphs.Add('5', @( 0x00, 0x27, 0x45, 0x45, 0x45, 0x39 ))
$glyphs.Add('6', @( 0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30 ))
$glyphs.Add('7', @( 0x00, 0x01, 0x71, 0x09, 0x05, 0x03 ))
$glyphs.Add('8', @( 0x00, 0x36, 0x49, 0x49, 0x49, 0x36 ))
$glyphs.Add('9', @( 0x00, 0x06, 0x49, 0x49, 0x29, 0x1E ))
$glyphs.Add('A', @( 0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C ))
$glyphs.Add('B', @( 0x00, 0x7F, 0x49, 0x49, 0x49, 0x36 ))
$glyphs.Add('C', @( 0x00, 0x3E, 0x41, 0x41, 0x41, 0x22 ))
$glyphs.Add('D', @( 0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C ))
$glyphs.Add('E', @( 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41 ))
$glyphs.Add('F', @( 0x00, 0x7F, 0x09, 0x09, 0x09, 0x01 ))
$glyphs.Add('G', @( 0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A ))
$glyphs.Add('H', @( 0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F ))
$glyphs.Add('I', @( 0x00, 0x00, 0x41, 0x7F, 0x41, 0x00 ))
$glyphs.Add('J', @( 0x00, 0x20, 0x40, 0x41, 0x3F, 0x01 ))
$glyphs.Add('K', @( 0x00, 0x7F, 0x08, 0x14, 0x22, 0x41 ))
$glyphs.Add('L', @( 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40 ))
$glyphs.Add('M', @( 0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F ))
$glyphs.Add('N', @( 0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F ))
$glyphs.Add('O', @( 0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E ))
$glyphs.Add('P', @( 0x00, 0x7F, 0x09, 0x09, 0x09, 0x06 ))
$glyphs.Add('Q', @( 0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E ))
$glyphs.Add('R', @( 0x00, 0x7F, 0x09, 0x19, 0x29, 0x46 ))
$glyphs.Add('S', @( 0x00, 0x46, 0x49, 0x49, 0x49, 0x31 ))
$glyphs.Add('T', @( 0x00, 0x01, 0x01, 0x7F, 0x01, 0x01 ))
$glyphs.Add('U', @( 0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F ))
$glyphs.Add('V', @( 0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F ))
$glyphs.Add('W', @( 0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F ))
$glyphs.Add('X', @( 0x00, 0x63, 0x14, 0x08, 0x14, 0x63 ))
$glyphs.Add('Y', @( 0x00, 0x07, 0x08, 0x70, 0x08, 0x07 ))
$glyphs.Add('Z', @( 0x00, 0x61, 0x51, 0x49, 0x45, 0x43 ))
$glyphs.Add('a', @( 0x00, 0x20, 0x54, 0x54, 0x54, 0x78 ))
$glyphs.Add('b', @( 0x00, 0x7F, 0x48, 0x44, 0x44, 0x38 ))
$glyphs.Add('c', @( 0x00, 0x38, 0x44, 0x44, 0x44, 0x20 ))
$glyphs.Add('d', @( 0x00, 0x38, 0x44, 0x44, 0x48, 0x7F ))
$glyphs.Add('e', @( 0x00, 0x38, 0x54, 0x54, 0x54, 0x18 ))
$glyphs.Add('f', @( 0x00, 0x08, 0x7E, 0x09, 0x01, 0x02 ))
$glyphs.Add('g', @( 0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C ))
$glyphs.Add('h', @( 0x00, 0x7F, 0x08, 0x04, 0x04, 0x78 ))
$glyphs.Add('i', @( 0x00, 0x00, 0x44, 0x7D, 0x40, 0x00 ))
$glyphs.Add('j', @( 0x00, 0x40, 0x80, 0x84, 0x7D, 0x00 ))
$glyphs.Add('k', @( 0x00, 0x7F, 0x10, 0x28, 0x44, 0x00 ))
$glyphs.Add('l', @( 0x00, 0x00, 0x41, 0x7F, 0x40, 0x00 ))
$glyphs.Add('m', @( 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78 ))
$glyphs.Add('n', @( 0x00, 0x7C, 0x08, 0x04, 0x04, 0x78 ))
$glyphs.Add('o', @( 0x00, 0x38, 0x44, 0x44, 0x44, 0x38 ))
$glyphs.Add('p', @( 0x00, 0xFC, 0x24, 0x24, 0x24, 0x18 ))
$glyphs.Add('q', @( 0x00, 0x18, 0x24, 0x24, 0x18, 0xFC ))
$glyphs.Add('r', @( 0x00, 0x7C, 0x08, 0x04, 0x04, 0x08 ))
$glyphs.Add('s', @( 0x00, 0x48, 0x54, 0x54, 0x54, 0x20 ))
$glyphs.Add('t', @( 0x00, 0x04, 0x3F, 0x44, 0x40, 0x20 ))
$glyphs.Add('u', @( 0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C ))
$glyphs.Add('v', @( 0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C ))
$glyphs.Add('w', @( 0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C ))
$glyphs.Add('x', @( 0x00, 0x44, 0x28, 0x10, 0x28, 0x44 ))
$glyphs.Add('y', @( 0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C ))
$glyphs.Add('z', @( 0x00, 0x44, 0x64, 0x54, 0x4C, 0x44 ))
$glyphs.Add('[', @( 0x00, 0x00, 0x7F, 0x41, 0x41, 0x00 ))
$glyphs.Add(']', @( 0x00, 0x00, 0x41, 0x41, 0x7F, 0x00 ))
$glyphs.Add('^', @( 0x00, 0x04, 0x02, 0x01, 0x02, 0x04 ))
$glyphs.Add('_', @( 0x00, 0x40, 0x40, 0x40, 0x40, 0x40 ))
$glyphs.Add('`', @( 0x00, 0x01, 0x02, 0x04, 0x00 ))
$glyphs.Add('{', @( 0x00, 0x00, 0x08, 0x77, 0x00, 0x00 ))
$glyphs.Add('|', @( 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00 ))
$glyphs.Add('}', @( 0x00, 0x00, 0x77, 0x08, 0x00, 0x00 ))
$glyphs.Add('~', @( 0x00, 0x10, 0x08, 0x10, 0x08, 0x00 ))
$glyphs.Add(' ', @(0x00, 0x00))
$glyphs.Add('#', @( 0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14))
$glyphs.Add('\s', @( 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ))
$glyphs.Add('!', @( 0x00, 0x00, 0x6F, 0x00, 0x00, 0x00))
$glyphs.Add('"', @( 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 ))
$glyphs.Add('$', @( 0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12 ))
$glyphs.Add('%', @(0x00, 0x23, 0x13, 0x08, 0x64, 0x62 ))
$glyphs.Add('&', @(0x00, 0x36, 0x49, 0x55, 0x22, 0x50 ))
$glyphs.Add('(', @(0x00, 0x00, 0x1c, 0x22, 0x41, 0x00 ))
$glyphs.Add(')', @(0x00, 0x00, 0x41, 0x22, 0x1c, 0x00 ))
$glyphs.Add('*', @( 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14 ))
$glyphs.Add('+', @( 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08 ))
$glyphs.Add(',', @( 0x00, 0x00, 0x00, 0xA0, 0x60, 0x00 ))
$glyphs.Add('-', @( 0x00, 0x08, 0x08, 0x08, 0x08, 0x08 ))
$glyphs.Add('.', @( 0x00, 0x00, 0x60, 0x60, 0x00, 0x00 ))
$glyphs.Add('/', @( 0x00, 0x20, 0x10, 0x08, 0x04, 0x02 ))
$glyphs.Add(':', @( 0x00, 0x00, 0x36, 0x36, 0x00, 0x00 ))
$glyphs.Add(';', @( 0x00, 0x00, 0x56, 0x36, 0x00, 0x00 ))
$glyphs.Add('<', @( 0x00, 0x08, 0x14, 0x22, 0x41, 0x00 ))
$glyphs.Add('=', @( 0x00, 0x14, 0x14, 0x14, 0x14, 0x14 ))
$glyphs.Add('>', @( 0x00, 0x00, 0x41, 0x22, 0x14, 0x08 ))
$glyphs.Add('?', @( 0x00, 0x02, 0x01, 0x51, 0x09, 0x06 ))
$glyphs.Add('@', @( 0x00, 0x32, 0x49, 0x59, 0x51, 0x3E ))
$glyphs.Add("'", @(0x00, 0x00, 0x05, 0x03, 0x00, 0x00 ))
Write-Host "Glyphs added successfully."

# Load all the source files in the src directory
Write-Host "Loading source files..."
Get-ChildItem -Path "$PSscriptroot\src" -Filter '*.ps1' -File | ForEach-Object {
    try {
        Write-Host "Dot-sourcing $($_.FullName)"
        . $_.FullName
    } catch {
        Write-Error "Failed to load $($_.FullName): $_"
    }
}